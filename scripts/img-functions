function unmount_image () {
    # unmount from the chroot
    sudo umount -f $TMP_BUILD_DIR/mnt/dev || true
    sudo umount -f $TMP_BUILD_DIR/mnt/tmp/in_target.d || true
    # give it a second (ok really 5) to umount XXX - why? should instead track
    # the mount data / lsof etc.
    sleep 5
    # oh ya don't want to forget to unmount the image
    sudo umount -f $TMP_BUILD_DIR/mnt || true
}

function cleanup () {
    unmount_image
    rm -rf $TMP_BUILD_DIR
}

function mk_build_dir () {
  export TMP_BUILD_DIR=$(mktemp -t -d image.XXXXXXXX)
  [ $? -eq 0 ] || die "Failed to create tmp directory"
  trap cleanup ERR
  echo Building in $TMP_BUILD_DIR
}

function ensure_base_available () {
    if [ ! -f $IMG_PATH/$BASE_IMAGE_FILE ] ; then
       echo "Fetching Base Image"
       wget $CLOUD_IMAGES/$RELEASE/current/$BASE_IMAGE_FILE -O $IMG_PATH/$BASE_IMAGE_FILE.tmp
       mv $IMG_PATH/$BASE_IMAGE_FILE.tmp $IMG_PATH/$BASE_IMAGE_FILE
    fi
}
